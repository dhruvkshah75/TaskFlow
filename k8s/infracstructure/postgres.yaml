# ==========================================================
# PART 1: INTERNAL POSTGRES SERVICE (Headless)
# ==========================================================
apiVersion: v1
kind: Service
metadata:
  # This name "postgres-internal" is used internally by PgBouncer to find the DB.
  name: postgres-internal
  namespace: taskflow
spec:
  ports:
    - port: 5432
      targetPort: 5432
  selector:
    app: postgres
  clusterIP: None 

---

# ==========================================================
# PART 2: POSTGRES DEPLOYMENT (The Actual Database)
# ==========================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: taskflow
spec:
  # Databases are stateful. We usually run only 1 replica to avoid data clash 
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          # Loading secrets securely from 'k8s/01-secrets.yaml'
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: taskflow-db-secret
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: taskflow-db-secret
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              value: "taskflow_db"
            # This tells Postgres to store data in the mounted volume path
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          
          # MOUNTS: Connect the "virtual hard drive" (PVC) to the container
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
          
          # RESOURCES: Prevents the DB from eating all server RAM
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      
      # VOLUMES: Define the storage claim to use
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: postgres-pvc

---

# ==========================================================
# PART 3: PERSISTENT STORAGE (The Hard Drive)
# ==========================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-pvc
  namespace: taskflow
spec:
  # "ReadWriteOnce" means the volume can be mounted by only one node at a time.
  # This is standard for block storage (like AWS EBS or a local disk).
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      # Allocates 1GB of physical storage for database files.
      storage: 1Gi

---

# ==========================================================
# PART 4: PGBOUNCER SERVICE (The Connection Pooler)
# ==========================================================
apiVersion: v1
kind: Service
metadata:
  # This name "taskflow-pgbouncer" is what your API uses to connect.
  # e.g., POSTGRES_HOST = "taskflow-pgbouncer"
  name: taskflow-pgbouncer
  namespace: taskflow
spec:
  ports:
    - port: 6432        # The port the Service listens on
      targetPort: 6432  # The port the Container listens on
  selector:
    app: pgbouncer
  type: ClusterIP

---

# ==========================================================
# PART 5: PGBOUNCER DEPLOYMENT
# ==========================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
  namespace: taskflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pgbouncer
  template:
    metadata:
      labels:
        app: pgbouncer
    spec:
      containers:
        - name: pgbouncer
          image: edoburu/pgbouncer:latest
          ports:
            - containerPort: 6432
          
          # CONFIGURATION: Tells PgBouncer how to find the real Postgres
          env:
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: taskflow-db-secret
                  key: POSTGRES_USER
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: taskflow-db-secret
                  key: POSTGRES_PASSWORD
            
            # Connects to the internal headless service defined in Part 1
            - name: DB_HOST
              value: "postgres-internal"
            - name: DB_PORT
              value: "5432"
            
            # POOLING SETTINGS:
            # Transaction mode is best for modern web apps (FastAPI/Django).
            - name: POOL_MODE
              value: "transaction"
            - name: MAX_CLIENT_CONN
              value: "1000"
            - name: DEFAULT_POOL_SIZE
              value: "20"
            - name: LISTEN_PORT
              value: "6432"
            - name: AUTH_TYPE
              value: "scram-sha-256"
          
          resources:
            requests:
              memory: "64Mi"
              cpu: "100m"
            limits:
              memory: "128Mi"
              cpu: "250m"