name: Integration Stress Test

on:
  workflow_dispatch:
    

jobs:
  end-to-end-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
      
      - name: Create K8S Kind Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: taskflow-ci

      - name: Build docker images
        run: |
          docker build -t taskflow-api:test -f api/Dockerfile .
          docker build -t taskflow-worker:test -f worker/Dockerfile .

      - name: Load Images into Kind
        run: |
          kind load docker-image taskflow-api:test --name taskflow-ci
          kind load docker-image taskflow-worker:test --name taskflow-ci

      - name: Deploy Application
        run: |
          kubectl create namespace taskflow
          
          # Create secrets dynamically 
          kubectl create secret generic taskflow-db-secret \
            --namespace=taskflow \
            --from-literal=POSTGRES_DB=taskflow_db \
            --from-literal=POSTGRES_USER=postgres \
            --from-literal=POSTGRES_PASSWORD=password \
            --from-literal=DATABASE_URL=postgresql://postgres:password@taskflow-pgbouncer:6432/taskflow_db
          
          kubectl create secret generic taskflow-redis-secret \
            --namespace=taskflow \
            --from-literal=REDIS_PASSWORD=test_password \
            --from-literal=REDIS_HOST_HIGH=redis-high \
            --from-literal=REDIS_PORT_HIGH=6379 \
            --from-literal=REDIS_HOST_LOW=redis-low \
            --from-literal=REDIS_PORT_LOW=6379
          
          kubectl create secret generic taskflow-app-secret \
            --namespace=taskflow \
            --from-literal=SECRET_KEY=test_secret_key_for_ci_only \
            --from-literal=ALGORITHM=HS256 \
            --from-literal=ACCESS_TOKEN_EXPIRE_MINUTES=60
          
          sed -i 's|ghcr.io/dhruvkshah75/taskflow-api:latest|taskflow-api:test|g' k8s/apps/api.yaml
          sed -i 's|ghcr.io/dhruvkshah75/taskflow-worker:latest|taskflow-worker:test|g' k8s/apps/worker.yaml
          sed -i 's|imagePullPolicy: Always|imagePullPolicy: Never|g' k8s/apps/*.yaml
          sed -i 's|imagePullPolicy: IfNotPresent|imagePullPolicy: Never|g' k8s/apps/*.yaml
          
          kubectl apply -f k8s/02-configmaps.yaml
          kubectl apply -f k8s/infrastructure/
          kubectl apply -f k8s/apps/
          
          echo "Waiting for pods to be ready..."
          kubectl wait --namespace taskflow --for=condition=ready pod --selector=app=postgres --timeout=120s
          kubectl wait --namespace taskflow --for=condition=ready pod --selector=app=api --timeout=120s

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Test Dependencies
        run: pip install requests psycopg2-binary

      - name: Run Stress Test & Verification
        run: |
          kubectl port-forward -n taskflow svc/taskflow-pgbouncer 6432:6432 &
          kubectl port-forward -n taskflow svc/taskflow-api 8080:80 &
          
          sleep 10
          
          echo "Sending 200 tasks..."
          python tests/stress-test.py
          
          echo "verifying data..."
          python tests/verify_jobs.py
      
