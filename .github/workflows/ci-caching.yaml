name: Integration Stress Test (Parallel & Cached)

on:
  workflow_dispatch:

jobs:
  # JOB 1: BUILD ALL IMAGES IN PARALLEL (MATRIX STRATEGY)
  build-images:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        service: [api, worker, queue-manager]
        include:
          # Define specific Dockerfile paths for each service
          - service: api
            file: api/Dockerfile
            tag: taskflow-api:test
          - service: worker
            file: worker/Dockerfile
            tag: taskflow-worker:test
          - service: queue-manager
            file: core/Dockerfile   
            tag: taskflow-queue-manager:test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Export Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.file }}
          tags: ${{ matrix.tag }}
          # Export as a tar file (Artifact) instead of loading to Docker daemon
          outputs: type=docker,dest=/tmp/${{ matrix.service }}.tar
          # ⚡ CACHING: Scoped by service so they don't overwrite each other
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.service }}
          path: /tmp/${{ matrix.service }}.tar
          retention-days: 1

  # JOB 2: STRESS TEST (RUNS ONLY AFTER ALL BUILDS FINISH)
  end-to-end-test:
    needs: build-images   # <--- Waits for the parallel jobs to finish
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create K8S Kind Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: taskflow-ci

      # Download images from the previous parallel jobs
      - name: Download API Image
        uses: actions/download-artifact@v4
        with:
          name: image-api
          path: /tmp

      - name: Download Worker Image
        uses: actions/download-artifact@v4
        with:
          name: image-worker
          path: /tmp

      - name: Download Queue Manager Image
        uses: actions/download-artifact@v4
        with:
          name: image-queue-manager
          path: /tmp

      # FAST LOAD: Injects tarball directly into Kind (Bypassing Docker Daemon)
      - name: Load Images into Kind
        run: |
          kind load image-archive /tmp/api.tar --name taskflow-ci
          kind load image-archive /tmp/worker.tar --name taskflow-ci
          kind load image-archive /tmp/queue-manager.tar --name taskflow-ci

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # ⚡ NEW: Built-in pip caching (cleaner syntax)

      - name: Deploy Application
        run: |
          kubectl create namespace taskflow
          
          # 1. Create Secrets
          kubectl create secret generic taskflow-db-secret --namespace=taskflow \
            --from-literal=POSTGRES_DB=taskflow_db \
            --from-literal=POSTGRES_USER=postgres \
            --from-literal=POSTGRES_PASSWORD=password \
            --from-literal=DATABASE_URL=postgresql://postgres:password@taskflow-pgbouncer:6432/taskflow_db
          
          kubectl create secret generic taskflow-redis-secret --namespace=taskflow \
            --from-literal=REDIS_PASSWORD=test_password \
            --from-literal=REDIS_HOST_HIGH=redis-high --from-literal=REDIS_PORT_HIGH=6379 \
            --from-literal=REDIS_HOST_LOW=redis-low --from-literal=REDIS_PORT_LOW=6379
          
          kubectl create secret generic taskflow-app-secret --namespace=taskflow \
            --from-literal=SECRET_KEY=test_secret_key_for_ci_only --from-literal=ALGORITHM=HS256 --from-literal=ACCESS_TOKEN_EXPIRE_MINUTES=60
          
          # 2. Patch Manifests to use Local Test Images
          sed -i 's|image: .*taskflow-api.*|image: taskflow-api:test|g' k8s/apps/api.yaml
          sed -i 's|image: .*taskflow-worker.*|image: taskflow-worker:test|g' k8s/apps/worker.yaml
          sed -i 's|image: .*taskflow-queue-manager.*|image: taskflow-queue-manager:test|g' k8s/apps/queue-manager.yaml
          
          # 3. Force K8s to use local images (Never pull from internet)
          sed -i 's|imagePullPolicy: Always|imagePullPolicy: Never|g' k8s/apps/*.yaml
          sed -i 's|imagePullPolicy: IfNotPresent|imagePullPolicy: Never|g' k8s/apps/*.yaml
          
          # 4. Apply Everything
          kubectl apply -f k8s/02-configmaps.yaml
          kubectl apply -f k8s/infrastructure/
          kubectl apply -f k8s/apps/
          
          echo "Waiting for pods..."
          kubectl wait --namespace taskflow --for=condition=ready pod --selector=app=postgres --timeout=120s
          kubectl wait --namespace taskflow --for=condition=ready pod --selector=app=api --timeout=120s

      - name: Install Test Dependencies
        run: pip install requests psycopg2-binary

      - name: Run Stress Test & Verification
        run: |
          kubectl port-forward -n taskflow svc/taskflow-pgbouncer 6432:6432 &
          kubectl port-forward -n taskflow svc/taskflow-api 8080:80 &
          sleep 10
          
          echo "Starting Stress Test..."
          python tests/stress-test.py
          
          echo "Verifying Jobs..."
          python tests/verify_jobs.py